{% extends 'layout.html' %}

{% block title %}{% if theme == 'christmas' %}ğŸ„{% else %}ğŸ‘‘{% endif %} {{ event_type.name }} â€” KINGSHOT{% endblock %}

{% block content %}
  {% if theme == 'christmas' %}
  <h1>ğŸ„ {{ event_type.name }} Day {{ event_type.emoji }}</h1>
  <p class="subtitle">ğŸ… {{ event_date }} â€” 00:00 to 23:59 UTC ğŸ</p>
  {% else %}
  <h1>ğŸ‘‘ {{ event_type.name }} Day {{ event_type.emoji }}</h1>
  <p class="subtitle">âš”ï¸ {{ event_date }} â€” 00:00 to 23:59 UTC âš”ï¸</p>
  {% endif %}

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, msg in messages %}
        <div class="flash {{ category }}">{{ msg }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  {% if not registrations_open %}
  <!-- Countdown timer -->
  <div class="countdown-panel">
    <h2>â³ Registrations open in</h2>
    <div id="countdown" class="countdown-timer">
      <div class="countdown-item">
        <span id="countdown-days">--</span>
        <small>Days</small>
      </div>
      <div class="countdown-item">
        <span id="countdown-hours">--</span>
        <small>Hours</small>
      </div>
      <div class="countdown-item">
        <span id="countdown-minutes">--</span>
        <small>Minutes</small>
      </div>
      <div class="countdown-item">
        <span id="countdown-seconds">--</span>
        <small>Seconds</small>
      </div>
    </div>
    <p class="countdown-note">ğŸ”’ Booking will be available once the countdown ends.</p>
  </div>

  <script>
    (function() {
      const targetDate = new Date("{{ countdown_target }}Z");
      
      function updateCountdown() {
        const now = new Date();
        const diff = targetDate - now;
        
        if (diff <= 0) {
          // Reload page when countdown ends
          location.reload();
          return;
        }
        
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
        
        document.getElementById('countdown-days').textContent = String(days).padStart(2, '0');
        document.getElementById('countdown-hours').textContent = String(hours).padStart(2, '0');
        document.getElementById('countdown-minutes').textContent = String(minutes).padStart(2, '0');
        document.getElementById('countdown-seconds').textContent = String(seconds).padStart(2, '0');
      }
      
      updateCountdown();
      setInterval(updateCountdown, 1000);
    })();
  </script>
  {% else %}
  
  {% if not selection_state or not selection_state.completed %}
  <!-- Formulaire de prÃ©-inscription (avant sÃ©lection) -->
  <div class="reserve-panel">
    {% if theme == 'christmas' %}
    <h2>ğŸ Pre-register for the draw</h2>
    {% else %}
    <h2>âš”ï¸ Pre-register for the draw</h2>
    {% endif %}
    <p style="margin-top:4px;">Top {{ selection_top_n }} by speedups are selected when the timer ends. Others go to the waitlist.</p>
    {% if is_dual_list %}
      <p style="margin-top:4px;"><strong>âš ï¸ If you're on the waitlist after selection, you can switch to the secondary list to guarantee a slot!</strong></p>
    {% endif %}
    {% if selection_state and selection_state.ready_at %}
      <p class="countdown-note">Selection locks at <strong>{{ selection_state.ready_at }}</strong> UTC.</p>
    {% endif %}
    <form method="post" class="reserve-form">
      <input type="hidden" name="action" value="preregister">
      <div>
        <label>Player name</label>
        <input type="text" name="player_name" placeholder="Your in-game name" required>
      </div>
      <div>
        <label>Speedup days</label>
        <input type="number" name="speedup_days" min="1" value="20" required>
      </div>
      <div style="margin-top:16px;">
        {% if theme == 'christmas' %}
        <button type="submit">ğŸ Pre-register for draw</button>
        {% else %}
        <button type="submit">âš”ï¸ Pre-register for draw</button>
        {% endif %}
      </div>
    </form>
  </div>
  {% else %}
  <!-- Formulaires de rÃ©servation (aprÃ¨s sÃ©lection) -->
  {% if is_dual_list and selected_players_secondary %}
  <div class="reserve-forms-grid">
    <!-- Formulaire Main List -->
    <div class="reserve-panel">
      {% if theme == 'christmas' %}
      <h2><a href="{{ url_for('rydak_wheel') }}" title="Quel Rydak es-tu ?" style="text-decoration:none;">ğŸ°</a> ğŸ Main List</h2>
      {% else %}
      <h2><a href="{{ url_for('rydak_wheel') }}" title="Quel Rydak es-tu ?" style="text-decoration:none;">ğŸ°</a> âš”ï¸ Main List</h2>
      {% endif %}
      <form method="post" class="reserve-form">
        <input type="hidden" name="action" value="reserve">
        <div>
          <label>Available slot</label>
          <select name="slot" required>
            <option value="">-- Select a slot --</option>
            {% for s in free_slots_main %}
              <option value="{{ s.iso }}">{{ s.slot.strftime('%H:%M') }} UTC</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label>Selected player</label>
          <select name="player_name" required>
            <option value="">-- Choose your name --</option>
            {% if selected_players %}
              {% for p in selected_players %}
                <option value="{{ p.player_name }}">{{ p.player_name }} ({{ p.speedup_days }} days)</option>
              {% endfor %}
            {% endif %}
          </select>
        </div>
        <div style="margin-top:16px;">
          {% if theme == 'christmas' %}
          <button type="submit">ğŸ Confirm Reservation</button>
          {% else %}
          <button type="submit">âš”ï¸ Confirm Reservation</button>
          {% endif %}
        </div>
      </form>
    </div>

    <!-- Formulaire Secondary List -->
    <div class="reserve-panel">
      {% if theme == 'christmas' %}
      <h2>ğŸ Secondary List</h2>
      {% else %}
      <h2>âš”ï¸ Secondary List</h2>
      {% endif %}
      <form method="post" class="reserve-form">
        <input type="hidden" name="action" value="reserve">
        <div>
          <label>Available slot</label>
          <select name="slot" required>
            <option value="">-- Select a slot --</option>
            {% for s in free_slots_secondary %}
              <option value="{{ s.iso }}">{{ s.slot.strftime('%H:%M') }} UTC</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label>Selected player</label>
          <select name="player_name" required>
            <option value="">-- Choose your name --</option>
            {% if selected_players_secondary %}
              {% for p in selected_players_secondary %}
                <option value="{{ p.player_name }}">{{ p.player_name }}</option>
              {% endfor %}
            {% endif %}
          </select>
        </div>
        <div style="margin-top:16px;">
          {% if theme == 'christmas' %}
          <button type="submit">ğŸ Confirm Reservation</button>
          {% else %}
          <button type="submit">âš”ï¸ Confirm Reservation</button>
          {% endif %}
        </div>
      </form>
    </div>
  </div>
  {% else %}
  <!-- Formulaire Main List seul -->
  <div class="reserve-panel">
    {% if theme == 'christmas' %}
    <h2><a href="{{ url_for('rydak_wheel') }}" title="Quel Rydak es-tu ?" style="text-decoration:none;">ğŸ°</a> ğŸ Confirm slot</h2>
    {% else %}
    <h2><a href="{{ url_for('rydak_wheel') }}" title="Quel Rydak es-tu ?" style="text-decoration:none;">ğŸ°</a> âš”ï¸ Confirm slot</h2>
    {% endif %}
    <form method="post" class="reserve-form">
      <input type="hidden" name="action" value="reserve">
      <div>
        <label>Available slot</label>
        <select name="slot" required>
          <option value="">-- Select a slot --</option>
          {% for s in free_slots_main %}
            <option value="{{ s.iso }}">{{ s.slot.strftime('%H:%M') }} UTC</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label>Selected player</label>
        <select name="player_name" required>
          <option value="">-- Choose your name --</option>
          {% if selected_players %}
            {% for p in selected_players %}
              <option value="{{ p.player_name }}">{{ p.player_name }} ({{ p.speedup_days }} days)</option>
            {% endfor %}
          {% endif %}
        </select>
      </div>
      <div style="margin-top:16px;">
        {% if theme == 'christmas' %}
        <button type="submit">ğŸ Confirm Reservation</button>
        {% else %}
        <button type="submit">âš”ï¸ Confirm Reservation</button>
        {% endif %}
      </div>
    </form>
  </div>
  {% endif %}
  {% endif %}


  <!-- Slots table Main List -->
  {% if theme == 'christmas' %}
  <div class="crown-divider">ğŸ„ â„ï¸ ğŸ„</div>
  <h2 style="margin-top:16px;">ğŸ… Main List Schedule</h2>
  {% else %}
  <div class="crown-divider">ğŸ‘‘ âš”ï¸ ğŸ‘‘</div>
  <h2 style="margin-top:16px;">ğŸ—¡ï¸ Main List Schedule</h2>
  {% endif %}
  <table>
    <thead>
      <tr><th>Time</th><th>Status</th><th>Player</th><th>Speedups</th><th>Action</th></tr>
    </thead>
    <tbody>
      {% for s in slots_main %}
      <tr>
        <td data-label="Time">{{ s.slot.strftime('%H:%M') }} UTC</td>
        <td data-label="Status">
          {% if s.reserved %}
            <span class="badge reserve">Reserved</span>
          {% else %}
            <span class="badge libre">Available</span>
          {% endif %}
        </td>
        <td data-label="Player">{{ s.player if s.player else 'â€”' }}</td>
        <td data-label="Speedups">{{ (s.days|string ~ ' days') if s.days else 'â€”' }}</td>
        <td data-label="Action">
          {% if s.reserved %}
            <details class="move-dropdown">
              <summary class="btn-move">ğŸ”€</summary>
              <form method="post" class="move-form">
                <input type="hidden" name="action" value="move">
                <input type="hidden" name="old_slot" value="{{ s.iso }}">
                <select name="new_slot" required>
                  <option value="">-- New slot --</option>
                  {% for f in free_slots_main %}
                    <option value="{{ f.iso }}">{{ f.slot.strftime('%H:%M') }} UTC</option>
                  {% endfor %}
                </select>
                <input type="password" name="password" placeholder="Admin pwd" required>
                <button type="submit">âœ”ï¸</button>
              </form>
            </details>
          {% else %}
            â€”
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  {% if is_dual_list %}
  <!-- Slots table Secondary List -->
  {% if theme == 'christmas' %}
  <div class="crown-divider" style="margin-top:24px;">ğŸ„ â„ï¸ ğŸ„</div>
  <h2 style="margin-top:16px;">ğŸ… Secondary List Schedule</h2>
  {% else %}
  <div class="crown-divider" style="margin-top:24px;">ğŸ‘‘ âš”ï¸ ğŸ‘‘</div>
  <h2 style="margin-top:16px;">ğŸ—¡ï¸ Secondary List Schedule</h2>
  {% endif %}
  <table>
    <thead>
      <tr><th>Time</th><th>Status</th><th>Player</th><th>Speedups</th><th>Action</th></tr>
    </thead>
    <tbody>
      {% for s in slots_secondary %}
      <tr>
        <td data-label="Time">{{ s.slot.strftime('%H:%M') }} UTC</td>
        <td data-label="Status">
          {% if s.reserved %}
            <span class="badge reserve">Reserved</span>
          {% else %}
            <span class="badge libre">Available</span>
          {% endif %}
        </td>
        <td data-label="Player">{{ s.player if s.player else 'â€”' }}</td>
        <td data-label="Speedups">{{ (s.days|string ~ ' days') if s.days else 'â€”' }}</td>
        <td data-label="Action">
          {% if s.reserved %}
            <details class="move-dropdown">
              <summary class="btn-move">ğŸ”€</summary>
              <form method="post" class="move-form">
                <input type="hidden" name="action" value="move">
                <input type="hidden" name="old_slot" value="{{ s.iso }}">
                <select name="new_slot" required>
                  <option value="">-- New slot --</option>
                  {% for f in free_slots_secondary %}
                    <option value="{{ f.iso }}">{{ f.slot.strftime('%H:%M') }} UTC</option>
                  {% endfor %}
                </select>
                <input type="password" name="password" placeholder="Admin pwd" required>
                <button type="submit">âœ”ï¸</button>
              </form>
            </details>
          {% else %}
            â€”
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% endif %}

  <div class="crown-divider">â­ Selection â­</div>
  
  <div class="selection-grid">
    <!-- Selected Players -->
    <div class="selection-section">
      <h2>Selected (Top {{ selection_top_n }})</h2>
      <table>
        <thead>
          <tr><th>#</th><th>Player</th><th>Speedups</th>{% if is_dual_list and selection_state and selection_state.completed %}<th>Action</th>{% endif %}</tr>
        </thead>
        <tbody>
          {% if selected_players %}
            {% for p in selected_players %}
              <tr>
                <td data-label="#">{{ loop.index }}</td>
                <td data-label="Player">{{ p.player_name }}</td>
                <td data-label="Speedups">{{ p.speedup_days }} days</td>
                {% if is_dual_list and selection_state and selection_state.completed %}
                <td data-label="Action">
                  <form method="post" style="display:inline;" onsubmit="return confirm('Switch {{ p.player_name }} to List 2?');">
                    <input type="hidden" name="action" value="switch_to_secondary">
                    <input type="hidden" name="player_name" value="{{ p.player_name }}">
                    <button type="submit" class="btn-list2">â†’ List 2</button>
                  </form>
                </td>
                {% endif %}
              </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="{% if is_dual_list and selection_state and selection_state.completed %}4{% else %}3{% endif %}">No one selected yet.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    <!-- Waitlist -->
    <div class="selection-section">
      <h2>Waitlist</h2>
      <table>
        <thead>
          <tr><th>Pos</th><th>Player</th><th>Speedups</th>{% if is_dual_list and selection_state and selection_state.completed %}<th>Action</th>{% endif %}</tr>
        </thead>
        <tbody>
          {% if waitlist_players %}
            {% for p in waitlist_players %}
              <tr>
                <td data-label="Pos">{{ p.waitlist_position }}</td>
                <td data-label="Player">{{ p.player_name }}</td>
                <td data-label="Speedups">{{ p.speedup_days }} days</td>
                {% if is_dual_list and selection_state and selection_state.completed %}
                <td data-label="Action">
                  <form method="post" style="display:inline;" onsubmit="return confirm('Switch {{ p.player_name }} to List 2?');">
                    <input type="hidden" name="action" value="switch_to_secondary">
                    <input type="hidden" name="player_name" value="{{ p.player_name }}">
                    <button type="submit" class="btn-list2">â†’ List 2</button>
                  </form>
                </td>
                {% endif %}
              </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="{% if is_dual_list and selection_state and selection_state.completed %}4{% else %}3{% endif %}">No one on the waitlist.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
  
  {% if is_dual_list %}
  <div class="selection-section" style="margin-top:16px;">
    <h2>Secondary List (Open to all)</h2>
    <table>
      <thead>
        <tr><th>#</th><th>Player</th><th>Speedups</th></tr>
      </thead>
      <tbody>
        {% if selected_players_secondary %}
          {% for p in selected_players_secondary %}
            <tr>
              <td data-label="#">{{ loop.index }}</td>
              <td data-label="Player">{{ p.player_name }}</td>
              <td data-label="Speedups">{{ p.speedup_days }} days</td>
            </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="3">No one registered yet.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
  {% endif %}
  {% endif %}
{% endblock %}
