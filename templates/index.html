{% extends 'layout.html' %}

{% block title %}{% if theme == 'christmas' %}ğŸ„{% else %}ğŸ‘‘{% endif %} {{ event_type.name }} â€” KINGSHOT{% endblock %}

{% block content %}
  {% if theme == 'christmas' %}
  <h1>ğŸ„ {{ event_type.name }} Day {{ event_type.emoji }}</h1>
  <p class="subtitle">ğŸ… {{ event_date }} â€” 00:00 to 23:59 UTC ğŸ</p>
  {% else %}
  <h1>ğŸ‘‘ {{ event_type.name }} Day {{ event_type.emoji }}</h1>
  <p class="subtitle">âš”ï¸ {{ event_date }} â€” 00:00 to 23:59 UTC âš”ï¸</p>
  {% endif %}

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, msg in messages %}
        <div class="flash {{ category }}">{{ msg }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  {% if not registrations_open %}
  <!-- Countdown timer -->
  <div class="countdown-panel">
    <h2>â³ Registrations open in</h2>
    <div id="countdown" class="countdown-timer">
      <div class="countdown-item">
        <span id="countdown-days">--</span>
        <small>Days</small>
      </div>
      <div class="countdown-item">
        <span id="countdown-hours">--</span>
        <small>Hours</small>
      </div>
      <div class="countdown-item">
        <span id="countdown-minutes">--</span>
        <small>Minutes</small>
      </div>
      <div class="countdown-item">
        <span id="countdown-seconds">--</span>
        <small>Seconds</small>
      </div>
    </div>
    <p class="countdown-note">ğŸ”’ Booking will be available once the countdown ends.</p>
  </div>

  <script>
    (function() {
      const targetDate = new Date("{{ countdown_target }}Z");
      
      function updateCountdown() {
        const now = new Date();
        const diff = targetDate - now;
        
        if (diff <= 0) {
          // Reload page when countdown ends
          location.reload();
          return;
        }
        
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
        
        document.getElementById('countdown-days').textContent = String(days).padStart(2, '0');
        document.getElementById('countdown-hours').textContent = String(hours).padStart(2, '0');
        document.getElementById('countdown-minutes').textContent = String(minutes).padStart(2, '0');
        document.getElementById('countdown-seconds').textContent = String(seconds).padStart(2, '0');
      }
      
      updateCountdown();
      setInterval(updateCountdown, 1000);
    })();
  </script>
  {% else %}
  
  {% if not selection_state or not selection_state.completed %}
  
  <!-- Timer pour l'optimisation -->
  {% if selection_state and selection_state.ready_at %}
  <div class="countdown-panel" style="background: linear-gradient(135deg, rgba(218,165,32,0.15), rgba(255,215,0,0.1)); border: 2px solid #daa520;">
    <h2>âš¡ Optimization runs in</h2>
    <div id="optimization-countdown" class="countdown-timer">
      <div class="countdown-item">
        <span id="opti-days">--</span>
        <small>Days</small>
      </div>
      <div class="countdown-item">
        <span id="opti-hours">--</span>
        <small>Hours</small>
      </div>
      <div class="countdown-item">
        <span id="opti-minutes">--</span>
        <small>Minutes</small>
      </div>
      <div class="countdown-item">
        <span id="opti-seconds">--</span>
        <small>Seconds</small>
      </div>
    </div>
    <p class="countdown-note">ğŸ”® The algorithm will assign slots when the timer ends. Register before then!</p>
  </div>

  <script>
    (function() {
      const optiDate = new Date("{{ selection_state.ready_at }}");
      
      function updateOptiCountdown() {
        const now = new Date();
        const diff = optiDate - now;
        
        if (diff <= 0) {
          // Reload page when optimization completes
          location.reload();
          return;
        }
        
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
        
        document.getElementById('opti-days').textContent = String(days).padStart(2, '0');
        document.getElementById('opti-hours').textContent = String(hours).padStart(2, '0');
        document.getElementById('opti-minutes').textContent = String(minutes).padStart(2, '0');
        document.getElementById('opti-seconds').textContent = String(seconds).padStart(2, '0');
      }
      
      updateOptiCountdown();
      setInterval(updateOptiCountdown, 1000);
    })();
  </script>
  {% endif %}
  
  <!-- Formulaire de prÃ©-inscription (avant sÃ©lection) -->
  <div class="reserve-panel">
    {% if theme == 'christmas' %}
    <h2>ğŸ Pre-register with your preferred slots</h2>
    {% else %}
    <h2>âš”ï¸ Pre-register with your preferred slots</h2>
    {% endif %}
    <p style="margin-top:4px;">Select as many slots as you want. The system will optimize to maximize total speedups.</p>
    <p style="margin-top:4px;"><strong>You can only get 1 slot maximum.</strong> Select multiple to increase your chances!</p>
    {% if is_dual_list %}
      <p style="margin-top:4px;"><strong>âš ï¸ Dual list system: choose Main or Secondary list.</strong></p>
    {% endif %}
    <form method="post" class="reserve-form" id="prereg-form">
      <input type="hidden" name="action" value="preregister">
      <div>
        <label>Player name</label>
        <input type="text" name="player_name" placeholder="Your in-game name" required>
      </div>
      <div>
        <label>Speedup days</label>
        <input type="number" name="speedup_days" min="1" value="20" required>
      </div>
      
      <div style="margin-top:16px;">
        <label>Select your preferred slots (click to select/deselect):</label>
        <div style="max-height: 400px; overflow-y: auto; border: 1px solid #555; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 8px; margin-top: 8px;">
          {% for s in slots_main %}
            <div style="margin: 4px 0;">
              <label style="cursor: pointer; display: block; padding: 8px; border-radius: 4px; background: {% if s.reserved %}rgba(255,0,0,0.2){% else %}rgba(0,100,0,0.2){% endif %};">
                <input type="checkbox" name="selected_slots[]" value="{{ s.iso }}" 
                       {% if s.reserved %}disabled{% endif %}
                       class="slot-checkbox" 
                       style="margin-right: 8px;">
                <span>{{ s.slot.strftime('%H:%M') }} UTC</span>
                {% if s.reserved %}
                  <span style="color: #ff6b6b; margin-left: 8px;">(Reserved by {{ s.player }})</span>
                {% else %}
                  <span style="color: #51cf66; margin-left: 8px;">(Available)</span>
                {% endif %}
              </label>
            </div>
          {% endfor %}
        </div>
        <p id="selected-count" style="margin-top: 8px; font-size: 0.9em; color: #aaa;">Selected: 0 slots</p>
      </div>
      
      <div style="margin-top:16px;">
        {% if theme == 'christmas' %}
        <button type="submit">ğŸ Pre-register</button>
        {% else %}
        <button type="submit">âš”ï¸ Pre-register</button>
        {% endif %}
      </div>
    </form>
    
    <script>
      // Update selected count
      document.querySelectorAll('.slot-checkbox').forEach(cb => {
        cb.addEventListener('change', function() {
          const count = document.querySelectorAll('.slot-checkbox:checked').length;
          document.getElementById('selected-count').textContent = `Selected: ${count} slot${count !== 1 ? 's' : ''}`;
        });
      });
    </script>
  </div>
  
  <!-- Liste des joueurs prÃ©-enregistrÃ©s -->
  {% if all_preregistrations and all_preregistrations|length > 0 %}
  <div class="reserve-panel" style="margin-top: 24px;">
    <h2>ğŸ“‹ Registered Players ({{ all_preregistrations|length }})</h2>
    <p style="font-size: 0.9em; color: #aaa;">Check if you're already registered to avoid duplicate entries.</p>
    <table style="width: 100%; margin-top: 8px;">
      <thead>
        <tr>
          <th>#</th>
          <th>Player Name</th>
          <th>Speedups</th>
          <th>Preferred Slots</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        {% for prereg in all_preregistrations %}
        <tr>
          <td data-label="#">{{ loop.index }}</td>
          <td data-label="Player">{{ prereg.player_name }}</td>
          <td data-label="Speedups">{{ prereg.speedup_days }} days</td>
          <td data-label="Slots">
            {% set slots = prereg.preferred_slots|from_json %}
            {% if slots %}
              {{ slots|length }} slot{% if slots|length != 1 %}s{% endif %} selected
            {% else %}
              -
            {% endif %}
          </td>
          <td data-label="Status">
            {% if prereg.assigned_slot %}
              <span style="color: #51cf66;">âœ“ Assigned</span>
            {% else %}
              <span style="color: #ffa500;">â³ Pending</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}
  
  {% else %}
  <!-- Affichage aprÃ¨s sÃ©lection -->
  <div class="reserve-panel">
    <h2>âœ… Slot assignments completed!</h2>
    <p>The optimization algorithm has run. Check your assigned slot below.</p>
    
    {% if conflicts %}
      <div style="margin-top: 16px; padding: 12px; background: rgba(255,165,0,0.2); border: 2px solid orange; border-radius: 8px;">
        <h3 style="margin-top: 0;">âš ï¸ Conflicts detected!</h3>
        <p>The following slots have multiple players with identical speedups. Admin must manually resolve:</p>
        <ul>
          {% for conflict in conflicts %}
            <li>
              <strong>{{ conflict.slot_iso }}</strong> - 
              {{ conflict.player_names }} 
              ({{ conflict.speedup_days }} days each)
            </li>
          {% endfor %}
        </ul>
        <p><em>Contact admin to resolve these conflicts.</em></p>
      </div>
    {% endif %}
    
    <!-- Dernier inscrit -->
    {% if all_preregistrations and all_preregistrations|length > 0 %}
    <div style="margin-top: 16px; padding: 12px; background: linear-gradient(135deg, rgba(81,207,102,0.1), rgba(51,217,178,0.05)); border: 2px solid #51cf66; border-radius: 8px;">
      <h3 style="margin: 0 0 8px 0; font-size: 1em; color: #51cf66;">ğŸ¯ Latest Registration</h3>
      <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;">
        <span style="font-weight: bold; font-size: 1.1em;">{{ all_preregistrations[-1].player_name }}</span>
        <span style="color: #ffd43b;">{{ all_preregistrations[-1].speedup_days }} days</span>
        <span style="font-size: 0.85em; color: #aaa;">{{ all_preregistrations[-1].list_type|capitalize }} list</span>
        {% if all_preregistrations[-1].assigned_slot %}
          <span style="color: #51cf66;">âœ“ {{ all_preregistrations[-1].assigned_slot }}</span>
        {% else %}
          <span style="color: #ffa500;">â³ Pending</span>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>
  {% if is_dual_list and selected_players_secondary %}
  <div class="reserve-forms-grid">
    <!-- Formulaire Main List -->
    <div class="reserve-panel">
      {% if theme == 'christmas' %}
      <h2><a href="{{ url_for('rydak_wheel') }}" title="Quel Rydak es-tu ?" style="text-decoration:none;">ğŸ°</a> ğŸ Main List</h2>
      {% else %}
      <h2><a href="{{ url_for('rydak_wheel') }}" title="Quel Rydak es-tu ?" style="text-decoration:none;">ğŸ°</a> âš”ï¸ Main List</h2>
      {% endif %}
      <form method="post" class="reserve-form">
        <input type="hidden" name="action" value="reserve">
        <div>
          <label>Available slot</label>
          <select name="slot" required>
            <option value="">-- Select a slot --</option>
            {% for s in free_slots_main %}
              <option value="{{ s.iso }}">{{ s.slot.strftime('%H:%M') }} UTC</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label>Selected player</label>
          <select name="player_name" required>
            <option value="">-- Choose your name --</option>
            {% if selected_players %}
              {% for p in selected_players %}
                <option value="{{ p.player_name }}">{{ p.player_name }} ({{ p.speedup_days }} days)</option>
              {% endfor %}
            {% endif %}
          </select>
        </div>
        <div style="margin-top:16px;">
          {% if theme == 'christmas' %}
          <button type="submit">ğŸ Confirm Reservation</button>
          {% else %}
          <button type="submit">âš”ï¸ Confirm Reservation</button>
          {% endif %}
        </div>
      </form>
    </div>

    <!-- Formulaire Secondary List -->
    <div class="reserve-panel">
      {% if theme == 'christmas' %}
      <h2>ğŸ Secondary List</h2>
      {% else %}
      <h2>âš”ï¸ Secondary List</h2>
      {% endif %}
      <form method="post" class="reserve-form">
        <input type="hidden" name="action" value="reserve">
        <div>
          <label>Available slot</label>
          <select name="slot" required>
            <option value="">-- Select a slot --</option>
            {% for s in free_slots_secondary %}
              <option value="{{ s.iso }}">{{ s.slot.strftime('%H:%M') }} UTC</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label>Selected player</label>
          <select name="player_name" required>
            <option value="">-- Choose your name --</option>
            {% if selected_players_secondary %}
              {% for p in selected_players_secondary %}
                <option value="{{ p.player_name }}">{{ p.player_name }}</option>
              {% endfor %}
            {% endif %}
          </select>
        </div>
        <div style="margin-top:16px;">
          {% if theme == 'christmas' %}
          <button type="submit">ğŸ Confirm Reservation</button>
          {% else %}
          <button type="submit">âš”ï¸ Confirm Reservation</button>
          {% endif %}
        </div>
      </form>
    </div>
  </div>
  {% else %}
  <!-- Formulaire Main List seul -->
  <div class="reserve-panel">
    {% if theme == 'christmas' %}
    <h2><a href="{{ url_for('rydak_wheel') }}" title="Quel Rydak es-tu ?" style="text-decoration:none;">ğŸ°</a> ğŸ Confirm slot</h2>
    {% else %}
    <h2><a href="{{ url_for('rydak_wheel') }}" title="Quel Rydak es-tu ?" style="text-decoration:none;">ğŸ°</a> âš”ï¸ Confirm slot</h2>
    {% endif %}
    <form method="post" class="reserve-form">
      <input type="hidden" name="action" value="reserve">
      <div>
        <label>Available slot</label>
        <select name="slot" required>
          <option value="">-- Select a slot --</option>
          {% for s in free_slots_main %}
            <option value="{{ s.iso }}">{{ s.slot.strftime('%H:%M') }} UTC</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label>Selected player</label>
        <select name="player_name" required>
          <option value="">-- Choose your name --</option>
          {% if selected_players %}
            {% for p in selected_players %}
              <option value="{{ p.player_name }}">{{ p.player_name }} ({{ p.speedup_days }} days)</option>
            {% endfor %}
          {% endif %}
        </select>
      </div>
      <div style="margin-top:16px;">
        {% if theme == 'christmas' %}
        <button type="submit">ğŸ Confirm Reservation</button>
        {% else %}
        <button type="submit">âš”ï¸ Confirm Reservation</button>
        {% endif %}
      </div>
    </form>
  </div>
  {% endif %}
  {% endif %}


  <!-- Slots table Main List -->
  {% if theme == 'christmas' %}
  <div class="crown-divider">ğŸ„ â„ï¸ ğŸ„</div>
  <h2 style="margin-top:16px;">ğŸ… Main List Schedule</h2>
  {% else %}
  <div class="crown-divider">ğŸ‘‘ âš”ï¸ ğŸ‘‘</div>
  <h2 style="margin-top:16px;">ğŸ—¡ï¸ Main List Schedule</h2>
  {% endif %}
  <table>
    <thead>
      <tr><th>Time</th><th>Status</th><th>Player</th><th>Speedups</th></tr>
    </thead>
    <tbody>
      {% for s in slots_main %}
      <tr>
        <td data-label="Time">{{ s.slot.strftime('%H:%M') }} UTC</td>
        <td data-label="Status">
          {% if s.reserved %}
            <span class="badge reserve">Reserved</span>
          {% else %}
            <span class="badge libre">Available</span>
          {% endif %}
        </td>
        <td data-label="Player">{{ s.player if s.player else 'â€”' }}</td>
        <td data-label="Speedups">{{ (s.days|string ~ ' days') if s.days else 'â€”' }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Main List Statistics -->
  {% if stats_main %}
  <div class="reserve-panel" style="margin-top: 16px; background: linear-gradient(135deg, rgba(81,207,102,0.15), rgba(51,217,178,0.1)); border: 2px solid #51cf66;">
    <h3 style="margin-top: 0;">ğŸ“Š Main List Statistics</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-top: 12px;">
      <div style="text-align: center; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px;">
        <div style="font-size: 1.5em; font-weight: bold; color: #51cf66;">{{ stats_main.count }}</div>
        <div style="font-size: 0.85em; color: #aaa;">Assigned</div>
      </div>
      <div style="text-align: center; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px;">
        <div style="font-size: 1.5em; font-weight: bold; color: #ffd43b;">{{ stats_main.total }}</div>
        <div style="font-size: 0.85em; color: #aaa;">Total Speedups</div>
      </div>
      <div style="text-align: center; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px;">
        <div style="font-size: 1.5em; font-weight: bold; color: #ff6b6b;">{{ stats_main.min }}</div>
        <div style="font-size: 0.85em; color: #aaa;">Min</div>
      </div>
      <div style="text-align: center; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px;">
        <div style="font-size: 1.5em; font-weight: bold; color: #51cf66;">{{ stats_main.max }}</div>
        <div style="font-size: 0.85em; color: #aaa;">Max</div>
      </div>
      <div style="text-align: center; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px;">
        <div style="font-size: 1.5em; font-weight: bold; color: #74c0fc;">{{ "%.1f"|format(stats_main.avg) }}</div>
        <div style="font-size: 0.85em; color: #aaa;">Average</div>
      </div>
    </div>
  </div>
  {% endif %}

  {% if is_dual_list %}
  <!-- Slots table Secondary List -->
  {% if theme == 'christmas' %}
  <div class="crown-divider" style="margin-top:24px;">ğŸ„ â„ï¸ ğŸ„</div>
  <h2 style="margin-top:16px;">ğŸ… Secondary List Schedule</h2>
  {% else %}
  <div class="crown-divider" style="margin-top:24px;">ğŸ‘‘ âš”ï¸ ğŸ‘‘</div>
  <h2 style="margin-top:16px;">ğŸ—¡ï¸ Secondary List Schedule</h2>
  {% endif %}
  <table>
    <thead>
      <tr><th>Time</th><th>Status</th><th>Player</th><th>Speedups</th></tr>
    </thead>
    <tbody>
      {% for s in slots_secondary %}
      <tr>
        <td data-label="Time">{{ s.slot.strftime('%H:%M') }} UTC</td>
        <td data-label="Status">
          {% if s.reserved %}
            <span class="badge reserve">Reserved</span>
          {% else %}
            <span class="badge libre">Available</span>
          {% endif %}
        </td>
        <td data-label="Player">{{ s.player if s.player else 'â€”' }}</td>
        <td data-label="Speedups">{{ (s.days|string ~ ' days') if s.days else 'â€”' }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  
  <!-- Secondary List Statistics -->
  {% if stats_secondary %}
  <div class="reserve-panel" style="margin-top: 16px; background: linear-gradient(135deg, rgba(116,192,252,0.15), rgba(94,129,244,0.1)); border: 2px solid #74c0fc;">
    <h3 style="margin-top: 0;">ğŸ“Š Secondary List Statistics</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-top: 12px;">
      <div style="text-align: center; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px;">
        <div style="font-size: 1.5em; font-weight: bold; color: #74c0fc;">{{ stats_secondary.count }}</div>
        <div style="font-size: 0.85em; color: #aaa;">Assigned</div>
      </div>
      <div style="text-align: center; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px;">
        <div style="font-size: 1.5em; font-weight: bold; color: #ffd43b;">{{ stats_secondary.total }}</div>
        <div style="font-size: 0.85em; color: #aaa;">Total Speedups</div>
      </div>
      <div style="text-align: center; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px;">
        <div style="font-size: 1.5em; font-weight: bold; color: #ff6b6b;">{{ stats_secondary.min }}</div>
        <div style="font-size: 0.85em; color: #aaa;">Min</div>
      </div>
      <div style="text-align: center; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px;">
        <div style="font-size: 1.5em; font-weight: bold; color: #51cf66;">{{ stats_secondary.max }}</div>
        <div style="font-size: 0.85em; color: #aaa;">Max</div>
      </div>
      <div style="text-align: center; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px;">
        <div style="font-size: 1.5em; font-weight: bold; color: #74c0fc;">{{ "%.1f"|format(stats_secondary.avg) }}</div>
        <div style="font-size: 0.85em; color: #aaa;">Average</div>
      </div>
    </div>
  </div>
  {% endif %}
  {% endif %}

  <!-- Your Registration Status (moved to bottom) -->
  {% if selection_state and selection_state.completed and all_preregistrations and all_preregistrations|length > 0 %}
  <div class="reserve-panel" style="margin-top: 24px;">
    <h3>ğŸ“‹ Your Registration Status</h3>
    <p style="font-size: 0.9em; color: #aaa; margin-bottom: 12px;">Complete list of all registered players and their assigned slots.</p>
    <table style="width: 100%; margin-top: 8px;">
      <thead>
        <tr><th>Player</th><th>Speedups</th><th>Assigned Slot</th><th>List</th></tr>
      </thead>
      <tbody>
        {% for prereg in all_preregistrations %}
        <tr>
          <td data-label="Player">{{ prereg.player_name }}</td>
          <td data-label="Speedups">{{ prereg.speedup_days }} days</td>
          <td data-label="Slot">
            {% if prereg.assigned_slot %}
              <span style="color: #51cf66;">âœ“ {{ prereg.assigned_slot }}</span>
            {% else %}
              <span style="color: #ff6b6b;">No slot assigned</span>
            {% endif %}
          </td>
          <td data-label="List">{{ prereg.list_type|capitalize }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}

  {% endif %}
{% endblock %}
