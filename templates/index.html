{% extends 'layout.html' %}

{% block title %}{% if theme == 'christmas' %}ğŸ„{% else %}ğŸ‘‘{% endif %} {{ event_type.name }} â€” KINGSHOT{% endblock %}

{% block content %}
  {% if theme == 'christmas' %}
  <h1>ğŸ„ {{ event_type.name }} Day {{ event_type.emoji }}</h1>
  <p class="subtitle">ğŸ… {{ event_date }} â€” 00:00 to 23:59 UTC ğŸ</p>
  {% else %}
  <h1>ğŸ‘‘ {{ event_type.name }} Day {{ event_type.emoji }}</h1>
  <p class="subtitle">âš”ï¸ {{ event_date }} â€” 00:00 to 23:59 UTC âš”ï¸</p>
  {% endif %}

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, msg in messages %}
        <div class="flash {{ category }}">{{ msg }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  {% if not registrations_open %}
  <!-- Countdown timer -->
  <div class="countdown-panel">
    <h2>â³ Registrations open in</h2>
    <div id="countdown" class="countdown-timer">
      <div class="countdown-item">
        <span id="countdown-days">--</span>
        <small>Days</small>
      </div>
      <div class="countdown-item">
        <span id="countdown-hours">--</span>
        <small>Hours</small>
      </div>
      <div class="countdown-item">
        <span id="countdown-minutes">--</span>
        <small>Minutes</small>
      </div>
      <div class="countdown-item">
        <span id="countdown-seconds">--</span>
        <small>Seconds</small>
      </div>
    </div>
    <p class="countdown-note">ğŸ”’ Booking will be available once the countdown ends.</p>
  </div>

  <script>
    (function() {
      const targetDate = new Date("{{ countdown_target }}Z");
      
      function updateCountdown() {
        const now = new Date();
        const diff = targetDate - now;
        
        if (diff <= 0) {
          // Reload page when countdown ends
          location.reload();
          return;
        }
        
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
        
        document.getElementById('countdown-days').textContent = String(days).padStart(2, '0');
        document.getElementById('countdown-hours').textContent = String(hours).padStart(2, '0');
        document.getElementById('countdown-minutes').textContent = String(minutes).padStart(2, '0');
        document.getElementById('countdown-seconds').textContent = String(seconds).padStart(2, '0');
      }
      
      updateCountdown();
      setInterval(updateCountdown, 1000);
    })();
  </script>
  {% else %}
  <!-- Reservation form -->
  <div class="reserve-panel">
    {% if theme == 'christmas' %}
    <h2>ğŸ Claim Your Gift Slot</h2>
    {% else %}
    <h2>âš”ï¸ Claim Your Battle Slot</h2>
    {% endif %}
    <form method="post" class="reserve-form">
      <div>
        <label>Available slot</label>
        <select name="slot" required>
          <option value="">-- Select a slot --</option>
          {% for s in free_slots %}
            <option value="{{ s.iso }}">{{ s.slot.strftime('%H:%M') }} UTC</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label>Player name</label>
        <input type="text" name="player_name" placeholder="Your in-game name" required>
      </div>
      <div>
        <label>Speedup days (min. {{ min_speedup }})</label>
        <input type="number" name="speedup_days" min="{{ min_speedup }}" value="20" required>
      </div>
      <div style="margin-top:16px;">
        {% if theme == 'christmas' %}
        <button type="submit">ğŸ Confirm Reservation</button>
        {% else %}
        <button type="submit">âš”ï¸ Confirm Reservation</button>
        {% endif %}
      </div>
    </form>
  </div>
  {% endif %}

  <!-- Slots table -->
  {% if theme == 'christmas' %}
  <div class="crown-divider">ğŸ„ â„ï¸ ğŸ„</div>
  <h2 style="margin-top:16px;">ğŸ… Gift Schedule</h2>
  {% else %}
  <div class="crown-divider">ğŸ‘‘ âš”ï¸ ğŸ‘‘</div>
  <h2 style="margin-top:16px;">ğŸ—¡ï¸ Battle Schedule</h2>
  {% endif %}
  <table>
    <thead>
      <tr><th>Time</th><th>Status</th><th>Player</th><th>Speedups</th><th>Action</th></tr>
    </thead>
    <tbody>
      {% for s in slots %}
      <tr>
        <td data-label="Time">{{ s.slot.strftime('%H:%M') }} UTC</td>
        <td data-label="Status">
          {% if s.reserved %}
            <span class="badge reserve">Reserved</span>
          {% else %}
            <span class="badge libre">Available</span>
          {% endif %}
        </td>
        <td data-label="Player">{{ s.player if s.player else 'â€”' }}</td>
        <td data-label="Speedups">{{ (s.days|string ~ ' days') if s.days else 'â€”' }}</td>
        <td data-label="Action">
          {% if s.reserved %}
            <details class="move-dropdown">
              <summary class="btn-move">ğŸ”€</summary>
              <form method="post" class="move-form">
                <input type="hidden" name="action" value="move">
                <input type="hidden" name="old_slot" value="{{ s.iso }}">
                <select name="new_slot" required>
                  <option value="">-- New slot --</option>
                  {% for f in free_slots %}
                    <option value="{{ f.iso }}">{{ f.slot.strftime('%H:%M') }} UTC</option>
                  {% endfor %}
                </select>
                <input type="password" name="password" placeholder="Admin pwd" required>
                <button type="submit">âœ”ï¸</button>
              </form>
            </details>
          {% else %}
            â€”
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
{% endblock %}
