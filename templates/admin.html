{% extends 'layout.html' %}

{% block title %}ğŸ‘‘ Admin â€” KINGSHOT{% endblock %}

{% block content %}
  <h1>ğŸ‘‘ Command Center</h1>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, msg in messages %}
        <div class="flash {{ category }}">{{ msg }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="admin-section">
    <h2>ğŸ“… Admin Panel</h2>
    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">
      <a href="{{ url_for('admin', day='monday') }}" style="text-decoration: none;">
        <button type="button" class="day-selector-btn {% if selected_day == 'monday' %}active{% endif %}">
          ğŸ—ï¸ Monday - Construction
        </button>
      </a>
      <a href="{{ url_for('admin', day='tuesday') }}" style="text-decoration: none;">
        <button type="button" class="day-selector-btn {% if selected_day == 'tuesday' %}active{% endif %}">
          ğŸ”¬ Tuesday - Research
        </button>
      </a>
      <a href="{{ url_for('admin', day='thursday') }}" style="text-decoration: none;">
        <button type="button" class="day-selector-btn {% if selected_day == 'thursday' %}active{% endif %}">
          âš”ï¸ Thursday - Troop Training
        </button>
      </a>
      <a href="{{ url_for('admin', day='kvk_week') }}" style="text-decoration: none;">
        <button type="button" class="day-selector-btn {% if selected_day == 'kvk_week' %}active{% endif %}" style="background: linear-gradient(135deg, #8e44ad, #9b59b6); border-color: #9b59b6;">
          ğŸ“† Configure KVK Week
        </button>
      </a>
    </div>
    
    {% if selected_day == 'kvk_week' %}
    <!-- KVK Week Configuration Tab -->
    <div class="settings-info">
      <p style="font-size:1.1em; color:#9b59b6; font-weight:600;">ğŸ“† Configure Entire KVK Week</p>
      <p style="color:#888; font-size:0.95em;">Select Monday date - all other dates are calculated automatically</p>
    </div>
    
    <form method="post" class="admin-form" style="margin-top:24px;" onsubmit="return confirm('âš ï¸ WARNING: This will DELETE all preregistrations, reservations, and conflicts for ALL days.\n\nConfigure the entire KVK week?');">
      <input type="hidden" name="action" value="configure_week">
      
      <!-- Hidden fields with ISO format for backend -->
      <input type="hidden" id="monday_open_hidden" name="monday_open">
      <input type="hidden" id="tuesday_date_hidden" name="tuesday_date">
      <input type="hidden" id="tuesday_open_hidden" name="tuesday_open">
      <input type="hidden" id="thursday_date_hidden" name="thursday_date">
      <input type="hidden" id="thursday_open_hidden" name="thursday_open">
      
      <!-- Monday Selection (Primary) -->
      <div style="background:linear-gradient(135deg, rgba(218, 165, 32, 0.15), rgba(139, 69, 19, 0.1)); padding:20px; border-radius:12px; border:2px solid rgba(218, 165, 32, 0.4); margin-bottom:24px;">
        <h3 style="margin:0 0 16px 0; color:#daa520; font-size:1.3em;">ğŸ—ï¸ Monday Construction</h3>
        <div class="form-row">
          <div class="form-col">
            <label style="font-size:1.05em; color:#daa520; font-weight:600;">ğŸ“… Event Date</label>
            <input type="date" id="monday_date" name="monday_date" required style="border:3px solid #daa520; background:rgba(218, 165, 32, 0.1); font-size:1.05em; padding:14px; font-weight:600;">
          </div>
          <div class="form-col">
            <label style="font-size:0.95em; color:#c19a6b;">â° Pre-registration Opens</label>
            <input type="text" id="monday_open_display" readonly style="background:rgba(210, 105, 30, 0.08); color:#c19a6b; font-weight:600; cursor:not-allowed; border:2px dashed rgba(210, 105, 30, 0.3);">
            <small style="color:#888; font-size:0.85em; display:block; margin-top:4px;">ğŸ“ Auto: Saturday 00:00 UTC</small>
          </div>
        </div>
      </div>
      
      <!-- Tuesday (Auto-calculated) -->
      <div style="background:rgba(210, 105, 30, 0.05); padding:18px; border-radius:10px; border:2px dashed rgba(210, 105, 30, 0.25); margin-bottom:16px; opacity:0.9;">
        <h3 style="margin:0 0 14px 0; color:#d2691e; font-size:1.15em;">ğŸ”¬ Tuesday Research</h3>
        <div class="form-row">
          <div class="form-col">
            <label style="font-size:0.95em; color:#a0522d;">ğŸ“… Event Date</label>
            <input type="text" id="tuesday_date_display" readonly style="background:rgba(210, 105, 30, 0.08); color:#a0522d; font-weight:600; cursor:not-allowed; border:2px dashed rgba(210, 105, 30, 0.3);">
            <small style="color:#888; font-size:0.85em; display:block; margin-top:4px;">ğŸ“ Auto: Monday + 1 day</small>
          </div>
          <div class="form-col">
            <label style="font-size:0.95em; color:#a0522d;">â° Pre-registration Opens</label>
            <input type="text" id="tuesday_open_display" readonly style="background:rgba(210, 105, 30, 0.08); color:#a0522d; font-weight:600; cursor:not-allowed; border:2px dashed rgba(210, 105, 30, 0.3);">
            <small style="color:#888; font-size:0.85em; display:block; margin-top:4px;">ğŸ“ Auto: Sunday 00:00 UTC</small>
          </div>
        </div>
      </div>
      
      <!-- Thursday (Auto-calculated) -->
      <div style="background:rgba(210, 105, 30, 0.05); padding:18px; border-radius:10px; border:2px dashed rgba(210, 105, 30, 0.25); margin-bottom:24px; opacity:0.9;">
        <h3 style="margin:0 0 14px 0; color:#d2691e; font-size:1.15em;">âš”ï¸ Thursday Troop Training</h3>
        <div class="form-row">
          <div class="form-col">
            <label style="font-size:0.95em; color:#a0522d;">ğŸ“… Event Date</label>
            <input type="text" id="thursday_date_display" readonly style="background:rgba(210, 105, 30, 0.08); color:#a0522d; font-weight:600; cursor:not-allowed; border:2px dashed rgba(210, 105, 30, 0.3);">
            <small style="color:#888; font-size:0.85em; display:block; margin-top:4px;">ğŸ“ Auto: Monday + 3 days</small>
          </div>
          <div class="form-col">
            <label style="font-size:0.95em; color:#a0522d;">â° Pre-registration Opens</label>
            <input type="text" id="thursday_open_display" readonly style="background:rgba(210, 105, 30, 0.08); color:#a0522d; font-weight:600; cursor:not-allowed; border:2px dashed rgba(210, 105, 30, 0.3);">
            <small style="color:#888; font-size:0.85em; display:block; margin-top:4px;">ğŸ“ Auto: Tuesday 00:00 UTC</small>
          </div>
        </div>
      </div>
      
      <div>
        <label>ğŸ”‘ Admin password</label>
        <input type="password" name="password" placeholder="Enter password" required>
      </div>
      
      <button type="submit" style="background:linear-gradient(135deg, #8e44ad, #9b59b6); font-size:1.1em; padding:14px 28px;">ğŸ“† Configure Entire Week</button>
    </form>
    
    {% else %}
    <!-- Day Management Tab (Monday/Tuesday/Thursday) -->
    <div class="settings-info">
      <p><strong>Managing:</strong> <span style="color:#daa520; text-transform: capitalize;">{{ selected_day }}</span></p>
      <p><strong>Event Date:</strong> <span style="color:#daa520;">{{ current_date }}</span></p>
      <p><strong>Total reservations:</strong> {{ reservation_count }}</p>
      {% if registration_open %}
      <p><strong>Registrations open:</strong> <span style="color:#ff6b35;">{{ registration_open[:16].replace('T', ' ') }} UTC</span></p>
      {% else %}
      <p><strong>Registrations:</strong> <span style="color:#7fff00;">Open immediately</span></p>
      {% endif %}
    </div>
    
    <form method="post" class="admin-form" style="margin-top:16px;">
      <input type="hidden" name="action" value="set_event_settings">
      <input type="hidden" name="selected_day" value="{{ selected_day }}">
      
      <div class="form-row">
        <div class="form-col">
          <label>ğŸ“… Event Date</label>
          <input type="date" name="event_date" value="{{ current_date }}" required>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-col">
          <label>â° Registration Opens (Date)</label>
          <input type="date" name="open_date" {% if registration_open %}value="{{ registration_open[:10] }}"{% endif %}>
        </div>
        <div class="form-col">
          <label>â° Time (UTC)</label>
          <input type="time" name="open_time" {% if registration_open %}value="{{ registration_open[11:16] }}"{% endif %}>
        </div>
      </div>
      <p style="font-size:0.85em; color:#888; margin-top:4px;">Leave registration date/time empty to open immediately.</p>
      
      <div>
        <label>ğŸ”‘ Admin password</label>
        <input type="password" name="password" placeholder="Enter password" required>
      </div>
      
      <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
        <button type="submit">ğŸ’¾ Save settings</button>
        <button type="submit" name="clear_reservations" value="1" style="background:#e74c3c;" onclick="return confirm('This will also clear all reservations. Continue?');">ğŸ’¾ Save & clear reservations</button>
      </div>
    </form>
  </div>

  <div class="admin-section">
    <h2>ğŸ—¡ï¸ Reset Reservations Only</h2>
    <form method="post" class="admin-form" onsubmit="return confirm('Are you sure you want to delete all reservations for {{ selected_day }}?');">
      <input type="hidden" name="action" value="reset">
      <input type="hidden" name="selected_day" value="{{ selected_day }}">
      <div>
        <label>Admin password</label>
        <input type="password" name="password" placeholder="Enter password" required>
      </div>
      <button type="submit" style="background:#e74c3c;">ğŸ—‘ï¸ Clear all reservations for {{ selected_day }}</button>
    </form>
  </div>

  <div class="admin-section">
    <h2>â˜ ï¸ Delete a Single Reservation</h2>
    {% if reservations and reservations|length > 0 %}
    <form method="post" class="admin-form" onsubmit="return confirm('Delete this reservation?');">
      <input type="hidden" name="action" value="delete_one">
      <input type="hidden" name="selected_day" value="{{ selected_day }}">
      <div>
        <label>Select reservation to delete</label>
        <select name="reservation_id" required>
          <option value="">-- Select --</option>
          {% set main_list_reservations = reservations | selectattr('list_type', 'equalto', 'main') | list %}
          {% set secondary_list_reservations = reservations | selectattr('list_type', 'equalto', 'secondary') | list %}
          
          {% if main_list_reservations %}
            <optgroup label="ğŸ“‹ Main List">
            {% for r in main_list_reservations %}
              <option value="{{ r['id'] }}">[Main] {{ r['event_date'][:16].replace('T', ' ') }} - {{ r['player_name'] }} ({{ r['speedup_days'] }} days)</option>
            {% endfor %}
            </optgroup>
          {% endif %}
          
          {% if secondary_list_reservations %}
            <optgroup label="ğŸ“‹ Secondary List">
            {% for r in secondary_list_reservations %}
              <option value="{{ r['id'] }}">[List 2] {{ r['event_date'][:16].replace('T', ' ') }} - {{ r['player_name'] }} ({{ r['speedup_days'] }} days)</option>
            {% endfor %}
            </optgroup>
          {% endif %}
        </select>
      </div>
      <div>
        <label>Admin password</label>
        <input type="password" name="password" placeholder="Enter password" required>
      </div>
      <button type="submit" style="background:#e67e22;">âŒ Delete selected</button>
    </form>
    {% else %}
    <p style="color:#888;">No reservations to delete.</p>
    {% endif %}
  </div>

  <div class="admin-section">
    <h2>ğŸ—‘ï¸ Supprimer une prÃ©-inscription</h2>
    <p style="font-size:0.9em; color:#ff6b35; margin-bottom:12px;">âš ï¸ Supprime la prÃ©-inscription et toutes les rÃ©servations associÃ©es pour ce joueur.</p>
    {% if preregistrations and preregistrations|length > 0 %}
    <form method="post" class="admin-form" onsubmit="return confirm('âš ï¸ ATTENTION : Supprimer cette prÃ©-inscription ET toutes les rÃ©servations de ce joueur pour ce jour ?\n\nCette action est irrÃ©versible.');"><script>document.currentForm=document.currentScript.parentElement;</script>
      <input type="hidden" name="action" value="delete_prereg">
      <input type="hidden" name="selected_day" value="{{ selected_day }}">
      <div>
        <label>SÃ©lectionner la prÃ©-inscription</label>
        <select name="prereg_id" required>
          <option value="">-- SÃ©lectionner --</option>
          {% set prereg_main = preregistrations | selectattr('list_type', 'equalto', 'main') | list %}
          {% set prereg_secondary = preregistrations | selectattr('list_type', 'equalto', 'secondary') | list %}

          {% if prereg_main %}
            <optgroup label="ğŸ“‹ Liste principale">
            {% for p in prereg_main %}
              <option value="{{ p['id'] }}">[Main] {{ p['player_name'] }} â€” {{ p['speedup_days'] }} jours â€” {{ p['created_at'][:16].replace('T', ' ') }} UTC</option>
            {% endfor %}
            </optgroup>
          {% endif %}

          {% if prereg_secondary %}
            <optgroup label="ğŸ“‹ Liste secondaire">
            {% for p in prereg_secondary %}
              <option value="{{ p['id'] }}">[List 2] {{ p['player_name'] }} â€” {{ p['speedup_days'] }} jours â€” {{ p['created_at'][:16].replace('T', ' ') }} UTC</option>
            {% endfor %}
            </optgroup>
          {% endif %}
        </select>
      </div>
      <div>
        <label>Mot de passe admin</label>
        <input type="password" name="password" placeholder="Entrer le mot de passe" required>
      </div>
      <button type="submit" style="background:#e74c3c;">ğŸ—‘ï¸ Supprimer la prÃ©-inscription</button>
    </form>
    {% else %}
    <p style="color:#888;">Aucune prÃ©-inscription Ã  supprimer.</p>
    {% endif %}
  </div>
  {% endif %}

  <div class="admin-section">
    <h2>ğŸ¨ Theme Settings</h2>
    <div class="settings-info">
      <p><strong>Current theme:</strong> 
        {% if theme == 'christmas' %}
        <span style="color:#c41e3a;">ğŸ„ Christmas</span>
        {% elif theme == 'cookies' %}
        <span style="color:#d2691e;">ğŸª Winter Cookies</span>
        {% else %}
        <span style="color:#daa520;">ğŸ‘‘ KINGSHOT</span>
        {% endif %}
      </p>
      <p><strong>Mode:</strong> 
        {% if theme_mode == 'auto' %}
        <span style="color:#7fff00;">Auto (Dec=Christmas, Jan25-Feb10=Cookies)</span>
        {% else %}
        <span style="color:#ff6b35;">Manual: {{ theme_mode }}</span>
        {% endif %}
      </p>
    </div>
    <form method="post" class="admin-form">
      <input type="hidden" name="action" value="set_theme">
      <input type="hidden" name="selected_day" value="{{ selected_day }}">
      <div>
        <label>Select Theme</label>
        <select name="theme" required>
          <option value="auto" {% if theme_mode == 'auto' %}selected{% endif %}>ğŸ”„ Auto (Season-based)</option>
          <option value="kingshot" {% if theme_mode == 'kingshot' %}selected{% endif %}>ğŸ‘‘ KINGSHOT (Royal Gold)</option>
          <option value="christmas" {% if theme_mode == 'christmas' %}selected{% endif %}>ğŸ„ Christmas (Holiday)</option>
          <option value="cookies" {% if theme_mode == 'cookies' %}selected{% endif %}>ğŸª Winter Cookies (Jan-Feb)</option>
        </select>
      </div>
      <div>
        <label>Admin password</label>
        <input type="password" name="password" placeholder="Enter password" required>
      </div>
      <button type="submit" style="background:linear-gradient(135deg, #228b22, #c41e3a);">ğŸ¨ Change Theme</button>
    </form>
  </div>

  {% if conflicts %}
  <div class="admin-section" style="border: 2px solid orange; background: rgba(255,165,0,0.1);">
    <h2>âš ï¸ Resolve Slot Conflicts</h2>
    <p>The following slots have multiple players with identical speedups. Choose the winner manually:</p>
    
    {% for conflict in conflicts %}
    <div style="margin: 16px 0; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 8px;">
      <p><strong>Slot:</strong> {{ conflict.slot_iso }} | <strong>Speedups:</strong> {{ conflict.speedup_days }} days</p>
      <p><strong>Conflicting players:</strong> {{ conflict.player_names|join(', ') }}</p>
      
      <form method="post" class="admin-form" style="margin-top: 8px;">
        <input type="hidden" name="action" value="resolve_conflict">
        <input type="hidden" name="selected_day" value="{{ selected_day }}">
        <input type="hidden" name="conflict_id" value="{{ conflict.id }}">
        
        <div>
          <label>Choose winner:</label>
          <select name="winner_name" required>
            <option value="">-- Select winner --</option>
            {% for player in conflict.player_names %}
              <option value="{{ player }}">{{ player }}</option>
            {% endfor %}
          </select>
        </div>
        
        <div>
          <label>Admin password</label>
          <input type="password" name="password" placeholder="Enter password" required>
        </div>
        
        <button type="submit" style="background: orange;">âœ”ï¸ Assign slot to winner</button>
      </form>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <div style="margin-top:32px;">
    <a class="btn" href="{{ url_for('index') }}">âš”ï¸ Return to Battle</a>
  </div>

  <script>
    // Auto-calculate all dates from Monday selection
    function calculateWeekDates() {
      const mondayInput = document.getElementById('monday_date');
      if (mondayInput && mondayInput.value) {
        // Parse date in UTC to avoid timezone issues
        const [year, month, day] = mondayInput.value.split('-').map(Number);
        const monday = new Date(Date.UTC(year, month - 1, day, 0, 0, 0));
        
        // Calculate Tuesday (Monday + 1 day)
        const tuesday = new Date(monday);
        tuesday.setUTCDate(tuesday.getUTCDate() + 1);
        const tuesdayStr = tuesday.toISOString().slice(0, 10);
        
        // Calculate Thursday (Monday + 3 days)
        const thursday = new Date(monday);
        thursday.setUTCDate(thursday.getUTCDate() + 3);
        const thursdayStr = thursday.toISOString().slice(0, 10);
        
        // Calculate pre-registration dates (2 days before each event at 00:00 UTC)
        const mondayOpen = new Date(monday);
        mondayOpen.setUTCDate(mondayOpen.getUTCDate() - 2); // Saturday
        const mondayOpenStr = mondayOpen.toISOString().slice(0, 16).replace('T', ' ');
        
        const tuesdayOpen = new Date(tuesday);
        tuesdayOpen.setUTCDate(tuesdayOpen.getUTCDate() - 2); // Sunday
        const tuesdayOpenStr = tuesdayOpen.toISOString().slice(0, 16).replace('T', ' ');
        
        const thursdayOpen = new Date(thursday);
        thursdayOpen.setUTCDate(thursdayOpen.getUTCDate() - 2); // Tuesday
        const thursdayOpenStr = thursdayOpen.toISOString().slice(0, 16).replace('T', ' ');
        
        // Fill hidden fields with ISO format (YYYY-MM-DDTHH:MM:SS) for backend
        document.getElementById('monday_open_hidden').value = mondayOpen.toISOString().slice(0, 19);
        document.getElementById('tuesday_date_hidden').value = tuesdayStr;
        document.getElementById('tuesday_open_hidden').value = tuesdayOpen.toISOString().slice(0, 19);
        document.getElementById('thursday_date_hidden').value = thursdayStr;
        document.getElementById('thursday_open_hidden').value = thursdayOpen.toISOString().slice(0, 19);
        
        // Fill display fields with user-friendly format (YYYY-MM-DD HH:MM UTC)
        document.getElementById('monday_open_display').value = mondayOpenStr + ' UTC';
        document.getElementById('tuesday_date_display').value = tuesdayStr;
        document.getElementById('tuesday_open_display').value = tuesdayOpenStr + ' UTC';
        document.getElementById('thursday_date_display').value = thursdayStr;
        document.getElementById('thursday_open_display').value = thursdayOpenStr + ' UTC';
      }
    }
    
    // Listen for Monday date changes
    const mondayDateInput = document.getElementById('monday_date');
    if (mondayDateInput) {
      mondayDateInput.addEventListener('change', calculateWeekDates);
      
      // Auto-calculate on page load if Monday date is already set
      if (mondayDateInput.value) {
        calculateWeekDates();
      }
    }
  </script>
{% endblock %}
